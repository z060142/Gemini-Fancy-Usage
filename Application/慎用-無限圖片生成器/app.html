<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 壓力測試圖片生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .control-panel {
            background-color: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #374151;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-start {
            background-color: #2563eb;
            color: white;
        }
        .btn-start:hover:not(:disabled) {
            background-color: #1d4ed8;
        }
        .btn-stop {
            background-color: #dc2626;
            color: white;
        }
        .btn-stop:hover:not(:disabled) {
            background-color: #b91c1c;
        }
        .image-card {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            background-color: #374151;
            transition: transform 0.2s ease-in-out;
        }
        .image-card:hover {
            transform: scale(1.02);
        }
        .image-card .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 2rem 0.75rem 0.75rem;
            font-size: 0.875rem;
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.3s ease-in-out;
        }
        .image-card:hover .overlay {
            opacity: 1;
            transform: translateY(0);
        }
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="flex flex-col h-screen">
        <!-- 控制面板 (固定在頂部) -->
        <header class="control-panel sticky top-0 z-10 p-4 shadow-lg">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-2xl font-bold text-center mb-4">API 壓力測試圖片生成器</h1>
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <input type="text" id="prompt-input" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md py-2 px-4 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="在此輸入您的中文圖片描述...">
                    <div class="flex gap-2">
                        <button id="start-btn" class="btn btn-start font-semibold py-2 px-6 rounded-md w-full sm:w-auto">開始</button>
                        <button id="stop-btn" class="btn btn-stop font-semibold py-2 px-6 rounded-md w-full sm:w-auto" disabled>停止</button>
                    </div>
                </div>
                <p id="status" class="text-center mt-3 text-gray-400 h-6"></p>
            </div>
        </header>

        <!-- 圖片歷史記錄 -->
        <main class="flex-grow overflow-y-auto p-4 lg:p-8">
            <div id="image-history" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <!-- 圖片卡片將會被插入到這裡 -->
            </div>
        </main>
    </div>

    <script type="module">
        // --- 狀態管理 ---
        let isRunning = false;
        let currentPrompt = '';

        // --- DOM 元素 ---
        const promptInput = document.getElementById('prompt-input');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusEl = document.getElementById('status');
        const imageHistoryEl = document.getElementById('image-history');

        // --- API 設定 ---
        const apiKey = ""; // Gemini and Imagen will use the provided key from the environment
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const imagenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

        // --- 事件監聽 ---
        startBtn.addEventListener('click', handleStart);
        stopBtn.addEventListener('click', handleStop);

        // --- 控制函數 ---
        function handleStart() {
            if (!promptInput.value.trim()) {
                statusEl.textContent = '錯誤：請先輸入初始描述！';
                return;
            }
            isRunning = true;
            currentPrompt = ''; // 重置 prompt
            imageHistoryEl.innerHTML = ''; // 清空歷史紀錄
            updateButtons();
            runStressTest();
        }

        function handleStop() {
            isRunning = false;
            statusEl.textContent = '已停止。您可以修改描述後重新開始。';
            updateButtons();
        }

        function updateButtons() {
            startBtn.disabled = isRunning;
            stopBtn.disabled = !isRunning;
            promptInput.disabled = isRunning;
        }

        // --- 主循環 ---
        async function runStressTest() {
            if (!isRunning) return;

            // 創建並添加加載指示器
            const loadingCard = createLoadingCard();
            imageHistoryEl.prepend(loadingCard);
            
            try {
                // 步驟 1: 取得下一個 prompt
                let nextPrompt;
                if (!currentPrompt) { // 首次運行
                    const initialPrompt = promptInput.value;
                    statusEl.textContent = `翻譯中: "${initialPrompt}"`;
                    nextPrompt = await translatePrompt(initialPrompt);
                } else { // 後續運行
                    statusEl.textContent = `基於 "${currentPrompt}" 產生新點子...`;
                    nextPrompt = await createNextPrompt(currentPrompt);
                }
                currentPrompt = nextPrompt;

                // 步驟 2: 生成圖片
                statusEl.textContent = `生成圖片: "${currentPrompt}"`;
                const imageUrl = await generateImage(currentPrompt);

                // 步驟 3: 移除加載器並顯示圖片
                loadingCard.remove();
                addImageToHistory(imageUrl, currentPrompt);

                // 步驟 4: 循環 (1秒後執行下一次)
                if (isRunning) {
                   setTimeout(runStressTest, 1000);
                }
            } catch (error) {
                console.error("壓力測試循環中發生錯誤:", error);
                statusEl.textContent = `發生錯誤，5秒後重試...`;
                loadingCard.remove(); // 移除加載器
                if (isRunning) {
                    setTimeout(runStressTest, 5000); // 發生錯誤時等待較長時間
                }
            }
        }

        // --- API 輔助函數 ---

        // 翻譯中文 Prompt
        async function translatePrompt(chineseText) {
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: `Translate the following Chinese text into a concise, creative, and effective English image generation prompt. Only return the prompt text itself, without any introductory phrases. Chinese text: "${chineseText}"` }]
                }]
            };
            const response = await fetch(geminiApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`翻譯 API 錯誤: ${response.statusText}`);
            const result = await response.json();
            return result.candidates[0].content.parts[0].text.trim();
        }

        // 創造新的 Prompt (已更新)
        async function createNextPrompt(previousPrompt) {
            const newInstruction = `You are an expert in creative image prompt engineering. Your task is to transform a given prompt into something new and unexpected.

Analyze the core subject of the previous prompt: "${previousPrompt}".

Now, create a new prompt that meets these criteria:
1.  **Artistic Style Overhaul:** The new prompt MUST specify a completely different artistic style. Think of diverse options like: specific painting styles (oil painting, watercolor, ukiyo-e), digital art forms (3D render, synthwave, pixel art), photography styles (macro photography, high-fashion), or the style of a famous artist (Van Gogh, H.R. Giger).
2.  **Thematic Shift with Weak Link:** The content should be weakly related to the original subject but deliberately different. Do not just change one word. Place the core subject, or a conceptually related one, into a completely new scenario, theme, or action.

For example, if the original prompt was 'a photorealistic cat sitting on a windowsill':
- Good new prompt: 'A medieval tapestry depicting a mythical lion-cat hybrid guarding a castle gate.' (Related subject, different style, different theme).
- Another good new prompt: 'A grainy, black and white photo of a stray cat's shadow in a lonely alley.' (Related subject, different style, different mood).
- Bad new prompt: 'a photorealistic dog sitting on a windowsill' (Just changed the subject).

Return ONLY the new English prompt text, without any explanation or introductory phrases.`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: newInstruction }]
                }]
            };
            const response = await fetch(geminiApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
             if (!response.ok) throw new Error(`新點子 API 錯誤: ${response.statusText}`);
            const result = await response.json();
            return result.candidates[0].content.parts[0].text.trim().replace(/"/g, ''); // 移除可能出現的引號
        }

        // 生成圖片
        async function generateImage(prompt) {
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            const response = await fetch(imagenApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
             if (!response.ok) throw new Error(`圖片生成 API 錯誤: ${response.statusText}`);
            const result = await response.json();
            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                 return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
            }
            throw new Error('圖片生成 API 未返回有效圖片。');
        }

        // --- UI 更新函數 ---
        
        function createLoadingCard() {
            const card = document.createElement('div');
            card.className = 'image-card flex justify-center items-center aspect-square';
            const loader = document.createElement('div');
            loader.className = 'loader';
            card.appendChild(loader);
            return card;
        }

        function addImageToHistory(imageUrl, prompt) {
            const card = document.createElement('div');
            card.className = 'image-card';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = prompt;
            img.className = 'w-full h-full object-cover aspect-square';
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.textContent = prompt;
            
            card.appendChild(img);
            card.appendChild(overlay);
            
            imageHistoryEl.prepend(card);
        }

    </script>
</body>
</html>
